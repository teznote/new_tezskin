var M=Object.create;var k=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var L=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var D=(s,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let i of j(r))!N.call(s,i)&&i!==t&&k(s,i,{get:()=>r[i],enumerable:!(e=G(r,i))||e.enumerable});return s};var u=(s,r,t)=>(t=s!=null?M(L(s)):{},D(r||!s||!s.__esModule?k(t,"default",{value:s,enumerable:!0}):t,s));var z={verbose:1,module:".virtual/master.css",config:"master.css.*",sources:[],include:["**/*.{html,js,jsx,ts,tsx,svelte,astro,vue,md,mdx,pug,php}"],exclude:["**/*.css","**/*.d.ts","**/*.test.*","**/*test.{js,cjs,mjs,ts}","**/*.options.*","**/*master.css.*","**/*master.css-extractor.*","**/*master.css-renderer.*","**/*README.md","**/dist/**","**/out/**","**/styles/**","**/public/**","**/node_modules/webpack*/**","**/node_modules/events/**","**/node_modules/html-entities/**","**/node_modules/ansi-html-community/**","**/node_modules/util/**","**/node_modules/react/**","**/node_modules/react-dom/**","**/node_modules/vue/**","**/node_modules/next/**","**/node_modules/astro/**","**/node_modules/svelte/**","**/node_modules/svelte-hmr/**","**/node_modules/@swc/**","**/node_modules/@sveltejs/**","**/node_modules/@angular/**","**/node_modules/.cache/**","**/node_modules/.vite/**"],classes:{fixed:[],ignored:[]}},v=z;var R=u(require("@master/css"));function y(s){s=B(s);let r=s.match(/\S+/g)??[],t=new Set;for(let e of r){for(let o of _(e))t.add(C(o));let i=O(e);if(i.size)for(let o of i)for(let a of _(o))t.add(C(a))}return Array.from(t).filter(e=>e&&!U(e))}var _=s=>P(s,t=>(t.match(/[^"'`]+/g)??[]).join("SPLIT_BY_THIS")).split("SPLIT_BY_THIS"),C=s=>{let r=s;return s=P(s,t=>t.replace(/^[^:@~(]*(?<!@>?)=/,"").replace(/[([{\\:#=.]+$/,"")),r===s||!s?s:C(s)},F=s=>s?.match(/((?<!\\)["'`])(?:\\\1|(?:(?!\1))[\S\s])*(?<!\\)\1/g),A=(s,r)=>(r?.forEach((t,e)=>{s=s.replace(t,`COMPLETE-STRING--${e}--`)}),s),P=(s,r)=>{let t=F(s);return s=A(s,t),s=r(s),t?.forEach((e,i)=>{s=s.replace(`COMPLETE-STRING--${i}--`,e)}),s},O=s=>{let r=new Set,t=/((?<!\\)["'`])((?:\\\1|(?:(?!\1))[\S\s])*)((?<!\\)\1)/g,e;for(;(e=t.exec(s))!==null;){e.index===t.lastIndex&&t.lastIndex++,r.add(e[2]);let i=O(e[2]);if(i.size)for(let o of i)r.add(o)}return r},B=s=>P(s,r=>r.replace(/\/\*(?:(?!\*\/)[\S\s])*\*\//g,"").replace(/<!--(?:(?!-->)[\S\s])*-->/g,"").replace(/\/\/.*/g,"").replace(/<style[^>]*>(?:(?!<\/style>)[\S\s])*<\/style>/g,"").replace(/import.*from\s*COMPLETE-STRING--\d+--/g,"").replace(/import\s*(?:COMPLETE-STRING--\d+--|\([^;\s]*\))/g,"").replace(/(?:require|import)\([^;\s]*\)/g,"").replace(/(?:@.*\n)+(?:export|function|class)/g,"")),U=s=>{let r=F(s),t=A(s,r),e=/{(.*)}/,i;for(;(i=e.exec(t))!==null;)return i[1].split(";").find(a=>$(a))!==void 0;return $(t)||q(s)},$=s=>!s||!s.match(/(?:\S*\{\S*\})|(?:^[\w\-()]+:\S+)|(?:^[\w-]+\(\S+\))|(?:^[@~]\S+$)|(?:^[\w-]+)/)&&!s.match(/center-content/)&&!s.match(/^(?:calc\(.*\)|\d+(?:%|ch|cm|em|ex|in|mm|pc|pt|px|rem|vh|vmax|vmin|vw|deg|grad|rad|turn|s)?)x(?:calc\(.*\)|\d+(?:%|ch|cm|em|ex|in|mm|pc|pt|px|rem|vh|vmax|vmin|vw|deg|grad|rad|turn|s)?)$/)||s.match(/\*\*/)||s.match(/:\[/)||s.match(/\$\{/)||s.match(/\{\{/)||s.match(/\(\{[^}]*\}/)||s.match(/<\w+>|<\/\w+>/)||s.match(/;$/)||s.match(/^\w+:\/\//)||s.match(/^@(?:ts-[^\s]+|charset|import|namespace|media|supports|document|page|font-face|keyframes|counter-style|font-feature-values|property|layer|[^/]+\/.*)$/)||s.match(/^~\/.+.\w+$/)||s.match(/function\(|\(.*\)=>/)||s.match(/^\$\(.*/)||s.match(/^COMPLETE-STRING--/),q=s=>{let r=[],t;for(let e=0;e<s.length;e++)switch(s[e]){case"(":case"[":case"{":r.push(s[e]);break;case")":case"]":case"}":if(t=r.pop(),s[e]===")"&&t!=="("||s[e]==="]"&&t!=="["||s[e]==="}"&&t!=="{")return!0;break}return r.length>0};var m=u(require("fs")),x=require("minimatch"),c=u(require("@techor/log")),S=require("@techor/extend"),E=u(require("explore-config")),T=require("@master/css-validator"),I=u(require("chokidar")),W=require("node:events");function b(s){if(typeof CSS<"u")return CSS.escape(s);if(arguments.length==0)throw new TypeError("`CSS.escape` requires an argument.");let r=String(s),t=r.length,e=-1,i="",o,a=r.charCodeAt(0);if(t==1&&a==45)return"\\"+r;for(;++e<t;){if(o=r.charCodeAt(e),o==0){i+="\uFFFD";continue}if(o>=1&&o<=31||o==127||e==0&&o>=48&&o<=57||e==1&&o>=48&&o<=57&&a==45){i+="\\"+o.toString(16)+" ";continue}if(o>=128||o==45||o==95||o>=48&&o<=57||o>=65&&o<=90||o>=97&&o<=122){i+=r.charAt(e);continue}i+="\\"+r.charAt(e)}return i}var p=require("@techor/glob"),d=u(require("path")),w=class extends W.EventEmitter{constructor(t="master.css-extractor.*",e=process.cwd()){super();this.customOptions=t;this.cwd=e}css;latentClasses=new Set;validClasses=new Set;invalidClasses=new Set;options;watching=!1;watchers=[];init(t=this.customOptions){return typeof t=="string"||Array.isArray(t)?this.options=(0,S.extend)(v,(0,E.default)(t,{on:{found:e=>c.default.ok`**${e}** file found`,notFound:()=>c.default.i`No **${t}** file found`},cwd:this.cwd}),t):this.options=(0,S.extend)(v,t),this.options.verbose>1&&(c.default.ok`**options**`,c.default.tree(this.options),c.default``),this.css=new R.default(typeof this.options.config=="object"?this.options.config:(0,E.default)(this.options.config,{cwd:this.cwd})||{}),this.emit("init",this.options,this.config),this}async reset(t=this.customOptions){return this.watching&&await this.disableWatch(),this.latentClasses.clear(),this.validClasses.clear(),this.invalidClasses.clear(),this.init(t),await this.prepare(),this.watching&&await this.initWatch(),this.emit("reset"),this}async destroy(){return this.latentClasses.clear(),this.validClasses.clear(),this.invalidClasses.clear(),this.removeAllListeners(),await this.closeWatch(),this.emit("destroy"),this}async prepare(){if(this.options.classes?.fixed?.length){for(let t of this.options.classes.fixed)this.css.insert(t);this.options.verbose&&c.default.ok`${this.options.classes.fixed.length} fixed classes inserted ${this.options.classes.fixed}`}await this.insertFiles(this.fixedSourcePaths)}extract(t,e){if(!t||!e||!this.isSourceAllowed(t))return[];let i=[];for(let o of y(e))this.latentClasses.has(o)||(this.latentClasses.add(o),i.push(o));return i}async insert(t,e){if(!e)return!1;let i=this.extract(t,e);if(!i.length)return!1;this.invalidClasses.size&&(i=i.filter(n=>!this.invalidClasses.has(n))),this.validClasses.size&&(i=i.filter(n=>!this.validClasses.has(n))),this.options.classes?.ignored?.length&&(i=i.filter(n=>{for(let h of this.options.classes.ignored)if(typeof h=="string"){if(h===n)return!1}else if(h.test(n))return!1;return!0}));let o=process.hrtime(),a=[];await Promise.all(i.map(async n=>{let h=(0,T.createValidRules)(n,{css:this.css});h.length?(this.css.insertRules(h),a.push(n),this.validClasses.add(n)):this.invalidClasses.add(n)})),o=process.hrtime(o);let f=Math.round((o[0]*1e9+o[1])/1e6*10)/10;return this.css.rules.length&&a.length&&(this.options.verbose&&c.default.ok`**${d.default.relative(this.cwd,t)}** ${a.length} classes inserted ${c.chalk.gray("in")} ${f}ms ${this.options.verbose>1?a:""}`,this.emit("change")),!0}insertFile(t){return this.insert(t,m.default.readFileSync(d.default.resolve(this.cwd,t),{encoding:"utf-8"}).toString())}insertFiles(t){return Promise.all(t.map(e=>this.insertFile(e)))}export(t=this.options.module){let e=d.default.resolve(this.cwd,t),i=d.default.dirname(e);m.default.existsSync(i)||m.default.mkdirSync(i,{recursive:!0}),m.default.writeFileSync(e,this.css.text),this.options.verbose&&c.default.success`${this.css.rules.length} rules exported ${c.chalk.gray("in")} **${t}**`,this.emit("export",t,e)}watchSource(t,e){this.watch("add change",t,i=>this.insertFile(i),e)}watch(t,e,i,o){o=(0,S.extend)({ignoreInitial:!0,cwd:this.cwd},o);let a=I.default.watch(e,o);this.watchers.push(a),t.split(" ").forEach(f=>a.on(f,i))}initWatch(){let t=this.resolvedConfigPath,e=this.resolvedOptionsPath;this.options.sources&&this.watchSource(this.options.sources),t&&this.watch("add change unlink",t,async()=>{this.options.verbose&&(c.default``,c.default.t`[change] **${this.configPath}**`),await this.reset(),this.emit("configChange")}),e&&this.watch("add change unlink",e,async()=>{this.options.verbose&&(c.default``,c.default.t`[change] **${this.customOptions}**`),await this.reset(),this.emit("optionsChange")})}async disableWatch(){this.watchers.length&&(await Promise.all(this.watchers.map(t=>t.removeAllListeners())),this.watchers.length=0)}async startWatch(){this.watching||(this.initWatch(),this.watching=!0,this.emit("watchStart"))}async closeWatch(){this.watching&&(this.watchers.length&&(await Promise.all(this.watchers.map(t=>t.close())),this.watchers.length=0),this.watching=!1,this.emit("watchClose"))}get fixedSourcePaths(){let{sources:t}=this.options;return t?.length?(0,p.explorePathsSync)(t,{cwd:this.cwd}).filter(e=>!!e):[]}get resolvedFixedSourcePaths(){return this.fixedSourcePaths.map(t=>d.default.resolve(this.cwd,t))}get allowedSourcePaths(){let{include:t,exclude:e}=this.options;return t?.length?(0,p.explorePathsSync)(t,{cwd:this.cwd,ignore:e}).filter(i=>!!i):[]}get resolvedAllowedSourcePaths(){return this.allowedSourcePaths.map(t=>d.default.resolve(this.cwd,t))}isSourceAllowed(t){t.includes("?")&&(t=t.split("?")[0]);let{include:e,exclude:i,sources:o}=this.options;for(let a of o)if((0,x.minimatch)(t,a))return!0;for(let a of e)if(!(0,x.minimatch)(t,a))return!1;for(let a of i)if((0,x.minimatch)(t,a))return!1;return!0}get config(){return this.css.config}get configPath(){if(typeof this.options.config=="string"||Array.isArray(this.options.config))return(0,p.explorePathSync)(this.options.config,{cwd:this.cwd})}get resolvedConfigPath(){let t=this.configPath;if(t)return d.default.resolve(this.cwd,t)}get optionsPath(){if(typeof this.customOptions=="string"||Array.isArray(this.customOptions))return(0,p.explorePathSync)(this.customOptions,{cwd:this.cwd})}get resolvedOptionsPath(){let t=this.optionsPath;if(t)return d.default.resolve(this.cwd,t)}get resolvedVirtualModuleId(){return"\0"+this.options.module}get slotCSSRule(){return"#"+b(this.options.module)+"{--slot:0}"}};var g=u(require("@techor/log"));module.exports=async function(r,t){let{watch:e,output:i,verbose:o,cwd:a,options:f}=t,n=new w(f,a);n.on("init",l=>{r?.length?(l.include=[],l.exclude=[]):(l.exclude.includes("**/node_modules/**")||l.exclude.push("**/node_modules/**"),l.exclude.includes("node_modules")||l.exclude.push("node_modules")),l.output=i,l.verbose=+o||l.verbose}),n.init();let h=async()=>{r?.length?await n.insertFiles(r):await n.insertFiles(n.allowedSourcePaths)};if(e){let l=async()=>{await h(),r?.length||n.watchSource(n.options.include,{ignored:n.options.exclude})};n.on("watchStart",async()=>{await n.prepare(),await l(),g.default``,g.default.t`Start watching source changes`}).on("reset",async()=>{await l(),g.default``,g.default.t`Restart watching source changes`}).on("change",()=>{n.export()}).on("watchClose",()=>{g.default``,g.default.t`Stop watching source changes`}),await n.startWatch()}else await n.prepare(),await h(),n.export();return n};
