var T={verbose:1,module:".virtual/master.css",config:"master.css.*",sources:[],include:["**/*.{html,js,jsx,ts,tsx,svelte,astro,vue,md,mdx,pug,php}"],exclude:["**/*.css","**/*.d.ts","**/*.test.*","**/*test.{js,cjs,mjs,ts}","**/*.options.*","**/*master.css.*","**/*master.css-extractor.*","**/*master.css-renderer.*","**/*README.md","**/dist/**","**/out/**","**/styles/**","**/public/**","**/node_modules/webpack*/**","**/node_modules/events/**","**/node_modules/html-entities/**","**/node_modules/ansi-html-community/**","**/node_modules/util/**","**/node_modules/react/**","**/node_modules/react-dom/**","**/node_modules/vue/**","**/node_modules/next/**","**/node_modules/astro/**","**/node_modules/svelte/**","**/node_modules/svelte-hmr/**","**/node_modules/@swc/**","**/node_modules/@sveltejs/**","**/node_modules/@angular/**","**/node_modules/.cache/**","**/node_modules/.vite/**"],classes:{fixed:[],ignored:[]}},p=T;var j=`/** @type {import('@master/css-extractor').Options} */
module.exports = {
    sources: [],
    classes: {
        fixed: [],
        ignored: []
    }
}
`;var D=`/** @type {import('@master/css-extractor').Config} */
export default {
    sources: [],
    classes: {
        fixed: [],
        ignored: []
    }
}
`;import I from"@master/css";function f(t){t=F(t);let o=t.match(/\S+/g)??[],s=new Set;for(let e of o){for(let i of C(e))s.add(m(i));let r=b(e);if(r.size)for(let i of r)for(let n of C(i))s.add(m(n))}return Array.from(s).filter(e=>e&&!O(e))}var C=t=>x(t,s=>(s.match(/[^"'`]+/g)??[]).join("SPLIT_BY_THIS")).split("SPLIT_BY_THIS"),m=t=>{let o=t;return t=x(t,s=>s.replace(/^[^:@~(]*(?<!@>?)=/,"").replace(/[([{\\:#=.]+$/,"")),o===t||!t?t:m(t)},P=t=>t?.match(/((?<!\\)["'`])(?:\\\1|(?:(?!\1))[\S\s])*(?<!\\)\1/g),E=(t,o)=>(o?.forEach((s,e)=>{t=t.replace(s,`COMPLETE-STRING--${e}--`)}),t),x=(t,o)=>{let s=P(t);return t=E(t,s),t=o(t),s?.forEach((e,r)=>{t=t.replace(`COMPLETE-STRING--${r}--`,e)}),t},b=t=>{let o=new Set,s=/((?<!\\)["'`])((?:\\\1|(?:(?!\1))[\S\s])*)((?<!\\)\1)/g,e;for(;(e=s.exec(t))!==null;){e.index===s.lastIndex&&s.lastIndex++,o.add(e[2]);let r=b(e[2]);if(r.size)for(let i of r)o.add(i)}return o},F=t=>x(t,o=>o.replace(/\/\*(?:(?!\*\/)[\S\s])*\*\//g,"").replace(/<!--(?:(?!-->)[\S\s])*-->/g,"").replace(/\/\/.*/g,"").replace(/<style[^>]*>(?:(?!<\/style>)[\S\s])*<\/style>/g,"").replace(/import.*from\s*COMPLETE-STRING--\d+--/g,"").replace(/import\s*(?:COMPLETE-STRING--\d+--|\([^;\s]*\))/g,"").replace(/(?:require|import)\([^;\s]*\)/g,"").replace(/(?:@.*\n)+(?:export|function|class)/g,"")),O=t=>{let o=P(t),s=E(t,o),e=/{(.*)}/,r;for(;(r=e.exec(s))!==null;)return r[1].split(";").find(n=>y(n))!==void 0;return y(s)||R(t)},y=t=>!t||!t.match(/(?:\S*\{\S*\})|(?:^[\w\-()]+:\S+)|(?:^[\w-]+\(\S+\))|(?:^[@~]\S+$)|(?:^[\w-]+)/)&&!t.match(/center-content/)&&!t.match(/^(?:calc\(.*\)|\d+(?:%|ch|cm|em|ex|in|mm|pc|pt|px|rem|vh|vmax|vmin|vw|deg|grad|rad|turn|s)?)x(?:calc\(.*\)|\d+(?:%|ch|cm|em|ex|in|mm|pc|pt|px|rem|vh|vmax|vmin|vw|deg|grad|rad|turn|s)?)$/)||t.match(/\*\*/)||t.match(/:\[/)||t.match(/\$\{/)||t.match(/\{\{/)||t.match(/\(\{[^}]*\}/)||t.match(/<\w+>|<\/\w+>/)||t.match(/;$/)||t.match(/^\w+:\/\//)||t.match(/^@(?:ts-[^\s]+|charset|import|namespace|media|supports|document|page|font-face|keyframes|counter-style|font-feature-values|property|layer|[^/]+\/.*)$/)||t.match(/^~\/.+.\w+$/)||t.match(/function\(|\(.*\)=>/)||t.match(/^\$\(.*/)||t.match(/^COMPLETE-STRING--/),R=t=>{let o=[],s;for(let e=0;e<t.length;e++)switch(t[e]){case"(":case"[":case"{":o.push(t[e]);break;case")":case"]":case"}":if(s=o.pop(),t[e]===")"&&s!=="("||t[e]==="]"&&s!=="["||t[e]==="}"&&s!=="{")return!0;break}return o.length>0};import u from"fs";import{minimatch as S}from"minimatch";import a,{chalk as k}from"@techor/log";import{extend as v}from"@techor/extend";import _ from"explore-config";import{createValidRules as M}from"@master/css-validator";import W from"chokidar";import{EventEmitter as G}from"node:events";function w(t){if(typeof CSS<"u")return CSS.escape(t);if(arguments.length==0)throw new TypeError("`CSS.escape` requires an argument.");let o=String(t),s=o.length,e=-1,r="",i,n=o.charCodeAt(0);if(s==1&&n==45)return"\\"+o;for(;++e<s;){if(i=o.charCodeAt(e),i==0){r+="\uFFFD";continue}if(i>=1&&i<=31||i==127||e==0&&i>=48&&i<=57||e==1&&i>=48&&i<=57&&n==45){r+="\\"+i.toString(16)+" ";continue}if(i>=128||i==45||i==95||i>=48&&i<=57||i>=65&&i<=90||i>=97&&i<=122){r+=o.charAt(e);continue}r+="\\"+o.charAt(e)}return r}import{explorePathsSync as $,explorePathSync as A}from"@techor/glob";import l from"path";var d=class extends G{constructor(s="master.css-extractor.*",e=process.cwd()){super();this.customOptions=s;this.cwd=e}css;latentClasses=new Set;validClasses=new Set;invalidClasses=new Set;options;watching=!1;watchers=[];init(s=this.customOptions){return typeof s=="string"||Array.isArray(s)?this.options=v(p,_(s,{on:{found:e=>a.ok`**${e}** file found`,notFound:()=>a.i`No **${s}** file found`},cwd:this.cwd}),s):this.options=v(p,s),this.options.verbose>1&&(a.ok`**options**`,a.tree(this.options),a``),this.css=new I(typeof this.options.config=="object"?this.options.config:_(this.options.config,{cwd:this.cwd})||{}),this.emit("init",this.options,this.config),this}async reset(s=this.customOptions){return this.watching&&await this.disableWatch(),this.latentClasses.clear(),this.validClasses.clear(),this.invalidClasses.clear(),this.init(s),await this.prepare(),this.watching&&await this.initWatch(),this.emit("reset"),this}async destroy(){return this.latentClasses.clear(),this.validClasses.clear(),this.invalidClasses.clear(),this.removeAllListeners(),await this.closeWatch(),this.emit("destroy"),this}async prepare(){if(this.options.classes?.fixed?.length){for(let s of this.options.classes.fixed)this.css.insert(s);this.options.verbose&&a.ok`${this.options.classes.fixed.length} fixed classes inserted ${this.options.classes.fixed}`}await this.insertFiles(this.fixedSourcePaths)}extract(s,e){if(!s||!e||!this.isSourceAllowed(s))return[];let r=[];for(let i of f(e))this.latentClasses.has(i)||(this.latentClasses.add(i),r.push(i));return r}async insert(s,e){if(!e)return!1;let r=this.extract(s,e);if(!r.length)return!1;this.invalidClasses.size&&(r=r.filter(c=>!this.invalidClasses.has(c))),this.validClasses.size&&(r=r.filter(c=>!this.validClasses.has(c))),this.options.classes?.ignored?.length&&(r=r.filter(c=>{for(let h of this.options.classes.ignored)if(typeof h=="string"){if(h===c)return!1}else if(h.test(c))return!1;return!0}));let i=process.hrtime(),n=[];await Promise.all(r.map(async c=>{let h=M(c,{css:this.css});h.length?(this.css.insertRules(h),n.push(c),this.validClasses.add(c)):this.invalidClasses.add(c)})),i=process.hrtime(i);let g=Math.round((i[0]*1e9+i[1])/1e6*10)/10;return this.css.rules.length&&n.length&&(this.options.verbose&&a.ok`**${l.relative(this.cwd,s)}** ${n.length} classes inserted ${k.gray("in")} ${g}ms ${this.options.verbose>1?n:""}`,this.emit("change")),!0}insertFile(s){return this.insert(s,u.readFileSync(l.resolve(this.cwd,s),{encoding:"utf-8"}).toString())}insertFiles(s){return Promise.all(s.map(e=>this.insertFile(e)))}export(s=this.options.module){let e=l.resolve(this.cwd,s),r=l.dirname(e);u.existsSync(r)||u.mkdirSync(r,{recursive:!0}),u.writeFileSync(e,this.css.text),this.options.verbose&&a.success`${this.css.rules.length} rules exported ${k.gray("in")} **${s}**`,this.emit("export",s,e)}watchSource(s,e){this.watch("add change",s,r=>this.insertFile(r),e)}watch(s,e,r,i){i=v({ignoreInitial:!0,cwd:this.cwd},i);let n=W.watch(e,i);this.watchers.push(n),s.split(" ").forEach(g=>n.on(g,r))}initWatch(){let s=this.resolvedConfigPath,e=this.resolvedOptionsPath;this.options.sources&&this.watchSource(this.options.sources),s&&this.watch("add change unlink",s,async()=>{this.options.verbose&&(a``,a.t`[change] **${this.configPath}**`),await this.reset(),this.emit("configChange")}),e&&this.watch("add change unlink",e,async()=>{this.options.verbose&&(a``,a.t`[change] **${this.customOptions}**`),await this.reset(),this.emit("optionsChange")})}async disableWatch(){this.watchers.length&&(await Promise.all(this.watchers.map(s=>s.removeAllListeners())),this.watchers.length=0)}async startWatch(){this.watching||(this.initWatch(),this.watching=!0,this.emit("watchStart"))}async closeWatch(){this.watching&&(this.watchers.length&&(await Promise.all(this.watchers.map(s=>s.close())),this.watchers.length=0),this.watching=!1,this.emit("watchClose"))}get fixedSourcePaths(){let{sources:s}=this.options;return s?.length?$(s,{cwd:this.cwd}).filter(e=>!!e):[]}get resolvedFixedSourcePaths(){return this.fixedSourcePaths.map(s=>l.resolve(this.cwd,s))}get allowedSourcePaths(){let{include:s,exclude:e}=this.options;return s?.length?$(s,{cwd:this.cwd,ignore:e}).filter(r=>!!r):[]}get resolvedAllowedSourcePaths(){return this.allowedSourcePaths.map(s=>l.resolve(this.cwd,s))}isSourceAllowed(s){s.includes("?")&&(s=s.split("?")[0]);let{include:e,exclude:r,sources:i}=this.options;for(let n of i)if(S(s,n))return!0;for(let n of e)if(!S(s,n))return!1;for(let n of r)if(S(s,n))return!1;return!0}get config(){return this.css.config}get configPath(){if(typeof this.options.config=="string"||Array.isArray(this.options.config))return A(this.options.config,{cwd:this.cwd})}get resolvedConfigPath(){let s=this.configPath;if(s)return l.resolve(this.cwd,s)}get optionsPath(){if(typeof this.customOptions=="string"||Array.isArray(this.customOptions))return A(this.customOptions,{cwd:this.cwd})}get resolvedOptionsPath(){let s=this.optionsPath;if(s)return l.resolve(this.cwd,s)}get resolvedVirtualModuleId(){return"\0"+this.options.module}get slotCSSRule(){return"#"+w(this.options.module)+"{--slot:0}"}};export{d as CSSExtractor,D as OPTIONS_ESM_TEXT,j as OPTIONS_TEXT,d as default,f as extractLatentClasses,p as options};
